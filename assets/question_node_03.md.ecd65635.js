import{_ as s,o as n,c as a,Q as l}from"./chunks/framework.273ff57c.js";const u=JSON.parse('{"title":"SSE","description":"","frontmatter":{},"headers":[],"relativePath":"question/node/03.md","filePath":"question/node/03.md","lastUpdated":1699188084000}'),p={name:"question/node/03.md"},o=l(`<h1 id="sse" tabindex="-1">SSE <a class="header-anchor" href="#sse" aria-label="Permalink to &quot;SSE&quot;">â€‹</a></h1><h2 id="ä»€ä¹ˆæ˜¯-sse" tabindex="-1">ä»€ä¹ˆæ˜¯ SSE <a class="header-anchor" href="#ä»€ä¹ˆæ˜¯-sse" aria-label="Permalink to &quot;ä»€ä¹ˆæ˜¯ SSE&quot;">â€‹</a></h2><p>â€‹ SSE(Server Sent Event) æ—¢æ˜¯æœåŠ¡ç«¯å‘é€æ¶ˆæ¯ï¼Œæ˜¯ä¸€ç§è½»é‡çº§é•¿è¿æ¥åè®®ï¼Œå’Œ websocket ä¸åŒï¼Œsocket å¯ä»¥åŒç«¯æ¥å—å‘é€æ¶ˆæ¯ï¼Œè€Œ SSE åªèƒ½ç”±æœåŠ¡ç«¯å‘é€æ¶ˆæ¯,å¹¶ä¸” SSE è‡ªåŠ¨ä¼šé‡è¿.</p><p>ä»â€œæœåŠ¡ç«¯ä¸»åŠ¨å‘æµè§ˆå™¨å®æ—¶æ¨é€æ¶ˆæ¯â€è¿™ä¸€ç‚¹æ¥çœ‹ï¼Œè¯¥ API ä¸ WebSockets API æœ‰ä¸€äº›ç›¸ä¼¼ä¹‹å¤„ã€‚ä½†æ˜¯ï¼Œè¯¥ API ä¸ WebSockers API çš„ä¸åŒä¹‹å¤„åœ¨äºï¼š</p><table><thead><tr><th>Server-Sent Events API</th><th>WebSockets API</th></tr></thead><tbody><tr><td>åŸºäº HTTP åè®®</td><td>åŸºäº TCP åè®®</td></tr><tr><td>å•å·¥ï¼Œåªèƒ½æœåŠ¡ç«¯å•å‘å‘é€æ¶ˆæ¯</td><td>å…¨åŒå·¥ï¼Œå¯ä»¥åŒæ—¶å‘é€å’Œæ¥æ”¶æ¶ˆæ¯</td></tr><tr><td>è½»é‡çº§ï¼Œä½¿ç”¨ç®€å•</td><td>ç›¸å¯¹å¤æ‚</td></tr><tr><td>å†…ç½®æ–­çº¿é‡è¿å’Œæ¶ˆæ¯è¿½è¸ªçš„åŠŸèƒ½</td><td>ä¸åœ¨åè®®èŒƒå›´å†…ï¼Œéœ€æ‰‹åŠ¨å®ç°</td></tr><tr><td>æ–‡æœ¬æˆ–ä½¿ç”¨ Base64 ç¼–ç å’Œ gzip å‹ç¼©çš„äºŒè¿›åˆ¶æ¶ˆæ¯</td><td>ç±»å‹å¹¿æ³›</td></tr><tr><td>æ”¯æŒ<strong>è‡ªå®šä¹‰</strong>äº‹ä»¶ç±»å‹</td><td>ä¸æ”¯æŒè‡ªå®šä¹‰äº‹ä»¶ç±»å‹</td></tr><tr><td>è¿æ¥æ•° HTTP/1.1 6 ä¸ªï¼ŒHTTP/2 å¯åå•†ï¼ˆé»˜è®¤ 100ï¼‰</td><td>è¿æ¥æ•°æ— é™åˆ¶</td></tr></tbody></table><p>â€‹ æœåŠ¡å™¨å‘é€äº‹ä»¶ï¼ˆSSEï¼‰å—åˆ°æ‰“å¼€è¿æ¥æ•°çš„é™åˆ¶ï¼Œè¿™ä¸ªé™åˆ¶æ˜¯<em>å¯¹äºæµè§ˆå™¨</em>çš„ï¼Œå¹¶ä¸”è®¾ç½®ä¸ºéå¸¸ä½çš„æ•°å­—ï¼ˆ6ï¼‰ï¼Œæ‰“å¼€å¤šä¸ªé€‰é¡¹å¡æ—¶å¯èƒ½ä¼šç‰¹åˆ«ç—›è‹¦ã€‚</p><p>â€‹ SSE åº”ç”¨åœºæ™¯ï¼šChatGPT.</p><p>ChatGPT è¿™ç§éœ€è¦è€—è´¹å¤§é‡æ—¶é—´è®¡ç®—æ‰èƒ½å¾—åˆ°æœ€ç»ˆç»“æœ,ä¸é€‚ç”¨ä¸ Ajax,å› ä¸º Ajax åªèƒ½ä¸€æ¬¡è¯·æ±‚å“åº”ä¸€æ¬¡ç»“æœ,ä¹Ÿå°±æ˜¯è¯´è¦æƒ³å¾—åˆ°å®Œæ•´æ•°æ®,å°±å¿…é¡»ç­‰å¾… GPT æŠŠå…¨éƒ¨çš„è®¡ç®—å®Œæˆæ‰èƒ½è¿”å›,ä¸­é—´å¯èƒ½ä¼šè€—è´¹å¾ˆå¤šæ—¶é—´.</p><h2 id="sse-æµè§ˆå™¨ä¸Šä½¿ç”¨" tabindex="-1">SSE æµè§ˆå™¨ä¸Šä½¿ç”¨ <a class="header-anchor" href="#sse-æµè§ˆå™¨ä¸Šä½¿ç”¨" aria-label="Permalink to &quot;SSE æµè§ˆå™¨ä¸Šä½¿ç”¨&quot;">â€‹</a></h2><p>ä½¿ç”¨æµè§ˆå™¨æä¾›çš„<code>EventSource</code>æ¥å®Œæˆ SSE é€šä¿¡,ç®€å•æ˜“ç”¨.é€šè¿‡<code>addEventListener</code>æ¥å®ç°è‡ªå®šä¹‰äº‹ä»¶çš„ç›‘å¬,å›è°ƒå¯ä»¥æ¥å—ä¸€ä¸ªå‚æ•°,è¿™ä¸ªå‚æ•°å°±æ˜¯æœåŠ¡ç«¯å“åº”çš„æ•°æ®.</p><p><code>EventSource</code>å†…ç½®äº†ä¸‰ç§äº‹ä»¶ï¼š</p><p><code>open</code> ï¼šè¿æ¥æˆåŠŸå°±è§¦å‘</p><p><code>error</code> :å‡ºé”™æˆ–å…³é—­æ—¶è§¦å‘</p><p><code>message</code>:æœåŠ¡ç«¯å“åº”çš„ SSE æŠ¥æ–‡æ•°æ®ä¸­ event å­—æ®µä¸º<code>message</code>æˆ–æ—  evetn å­—æ®µå°±è§¦å‘è¯¥äº‹ä»¶å›è°ƒã€‚</p><div class="language-html vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">&lt;!</span><span style="color:#85E89D;">DOCTYPE</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">html</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">&lt;</span><span style="color:#85E89D;">html</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">lang</span><span style="color:#E1E4E8;">=</span><span style="color:#9ECBFF;">&quot;en&quot;</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">  &lt;</span><span style="color:#85E89D;">head</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">    &lt;</span><span style="color:#85E89D;">meta</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">charset</span><span style="color:#E1E4E8;">=</span><span style="color:#9ECBFF;">&quot;UTF-8&quot;</span><span style="color:#E1E4E8;"> /&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">    &lt;</span><span style="color:#85E89D;">meta</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">http-equiv</span><span style="color:#E1E4E8;">=</span><span style="color:#9ECBFF;">&quot;X-UA-Compatible&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">content</span><span style="color:#E1E4E8;">=</span><span style="color:#9ECBFF;">&quot;IE=edge&quot;</span><span style="color:#E1E4E8;"> /&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">    &lt;</span><span style="color:#85E89D;">meta</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">name</span><span style="color:#E1E4E8;">=</span><span style="color:#9ECBFF;">&quot;viewport&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">content</span><span style="color:#E1E4E8;">=</span><span style="color:#9ECBFF;">&quot;width=device-width, initial-scale=1.0&quot;</span><span style="color:#E1E4E8;"> /&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">    &lt;</span><span style="color:#85E89D;">title</span><span style="color:#E1E4E8;">&gt;Document&lt;/</span><span style="color:#85E89D;">title</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">  &lt;/</span><span style="color:#85E89D;">head</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">  &lt;</span><span style="color:#85E89D;">body</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">    &lt;</span><span style="color:#85E89D;">h1</span><span style="color:#E1E4E8;">&gt;ä½ å¥½&lt;/</span><span style="color:#85E89D;">h1</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">    &lt;</span><span style="color:#85E89D;">button</span><span style="color:#E1E4E8;">&gt;å¼€å¯è¿æ¥&lt;/</span><span style="color:#85E89D;">button</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">    &lt;</span><span style="color:#85E89D;">button</span><span style="color:#E1E4E8;">&gt;æ–­å¼€è¿æ¥&lt;/</span><span style="color:#85E89D;">button</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">    &lt;</span><span style="color:#85E89D;">div</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">class</span><span style="color:#E1E4E8;">=</span><span style="color:#9ECBFF;">&quot;list&quot;</span><span style="color:#E1E4E8;">&gt;&lt;/</span><span style="color:#85E89D;">div</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">    &lt;</span><span style="color:#85E89D;">script</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> [</span><span style="color:#79B8FF;">start</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">end</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> document.</span><span style="color:#B392F0;">getElementsByTagName</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;button&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">list</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> end.nextElementSibling;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">let</span><span style="color:#E1E4E8;"> eventSource </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">startSSE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> () </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        eventSource </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">EventSource</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;/stream&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        eventSource.</span><span style="color:#B392F0;">addEventListener</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;customEvent&quot;</span><span style="color:#E1E4E8;">, (</span><span style="color:#FFAB70;">event</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">          console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(event);</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">li</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> document.</span><span style="color:#B392F0;">createElement</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;li&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">          li.innerText </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">JSON</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">stringify</span><span style="color:#E1E4E8;">(event.data);</span></span>
<span class="line"><span style="color:#E1E4E8;">          list.</span><span style="color:#B392F0;">append</span><span style="color:#E1E4E8;">(li);</span></span>
<span class="line"><span style="color:#E1E4E8;">        });</span></span>
<span class="line"><span style="color:#E1E4E8;">        eventSource.</span><span style="color:#B392F0;">onopen</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> () </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">          console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;SSEè¿æ¥æˆåŠŸ!&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        };</span></span>
<span class="line"><span style="color:#E1E4E8;">        eventSource.</span><span style="color:#B392F0;">onerror</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> () </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">          console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;SSEè¿æ¥å¤±è´¥!&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        };</span></span>
<span class="line"><span style="color:#E1E4E8;">      };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">closeSSE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> () </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (eventSource) {</span></span>
<span class="line"><span style="color:#E1E4E8;">          eventSource.</span><span style="color:#B392F0;">close</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">          console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;å…³é—­è¿æ¥!&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">      };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">      start.onclick </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> startSSE;</span></span>
<span class="line"><span style="color:#E1E4E8;">      end.onclick </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> closeSSE;</span></span>
<span class="line"><span style="color:#E1E4E8;">    &lt;/</span><span style="color:#85E89D;">script</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">  &lt;/</span><span style="color:#85E89D;">body</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">&lt;/</span><span style="color:#85E89D;">html</span><span style="color:#E1E4E8;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">&lt;!</span><span style="color:#22863A;">DOCTYPE</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">html</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">&lt;</span><span style="color:#22863A;">html</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">lang</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;en&quot;</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">  &lt;</span><span style="color:#22863A;">head</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;</span><span style="color:#22863A;">meta</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">charset</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;UTF-8&quot;</span><span style="color:#24292E;"> /&gt;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;</span><span style="color:#22863A;">meta</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">http-equiv</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;X-UA-Compatible&quot;</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">content</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;IE=edge&quot;</span><span style="color:#24292E;"> /&gt;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;</span><span style="color:#22863A;">meta</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">name</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;viewport&quot;</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">content</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;width=device-width, initial-scale=1.0&quot;</span><span style="color:#24292E;"> /&gt;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;</span><span style="color:#22863A;">title</span><span style="color:#24292E;">&gt;Document&lt;/</span><span style="color:#22863A;">title</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">  &lt;/</span><span style="color:#22863A;">head</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">  &lt;</span><span style="color:#22863A;">body</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;</span><span style="color:#22863A;">h1</span><span style="color:#24292E;">&gt;ä½ å¥½&lt;/</span><span style="color:#22863A;">h1</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;</span><span style="color:#22863A;">button</span><span style="color:#24292E;">&gt;å¼€å¯è¿æ¥&lt;/</span><span style="color:#22863A;">button</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;</span><span style="color:#22863A;">button</span><span style="color:#24292E;">&gt;æ–­å¼€è¿æ¥&lt;/</span><span style="color:#22863A;">button</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;</span><span style="color:#22863A;">div</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">class</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;list&quot;</span><span style="color:#24292E;">&gt;&lt;/</span><span style="color:#22863A;">div</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;</span><span style="color:#22863A;">script</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> [</span><span style="color:#005CC5;">start</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">end</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> document.</span><span style="color:#6F42C1;">getElementsByTagName</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;button&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">list</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> end.nextElementSibling;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">let</span><span style="color:#24292E;"> eventSource </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">startSSE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> () </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        eventSource </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">EventSource</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;/stream&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        eventSource.</span><span style="color:#6F42C1;">addEventListener</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;customEvent&quot;</span><span style="color:#24292E;">, (</span><span style="color:#E36209;">event</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">          console.</span><span style="color:#6F42C1;">log</span><span style="color:#24292E;">(event);</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">li</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> document.</span><span style="color:#6F42C1;">createElement</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;li&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">          li.innerText </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">JSON</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">stringify</span><span style="color:#24292E;">(event.data);</span></span>
<span class="line"><span style="color:#24292E;">          list.</span><span style="color:#6F42C1;">append</span><span style="color:#24292E;">(li);</span></span>
<span class="line"><span style="color:#24292E;">        });</span></span>
<span class="line"><span style="color:#24292E;">        eventSource.</span><span style="color:#6F42C1;">onopen</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> () </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">          console.</span><span style="color:#6F42C1;">log</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;SSEè¿æ¥æˆåŠŸ!&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        };</span></span>
<span class="line"><span style="color:#24292E;">        eventSource.</span><span style="color:#6F42C1;">onerror</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> () </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">          console.</span><span style="color:#6F42C1;">log</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;SSEè¿æ¥å¤±è´¥!&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        };</span></span>
<span class="line"><span style="color:#24292E;">      };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">closeSSE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> () </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (eventSource) {</span></span>
<span class="line"><span style="color:#24292E;">          eventSource.</span><span style="color:#6F42C1;">close</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">          console.</span><span style="color:#6F42C1;">log</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;å…³é—­è¿æ¥!&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">      };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">      start.onclick </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> startSSE;</span></span>
<span class="line"><span style="color:#24292E;">      end.onclick </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> closeSSE;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;/</span><span style="color:#22863A;">script</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">  &lt;/</span><span style="color:#22863A;">body</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">&lt;/</span><span style="color:#22863A;">html</span><span style="color:#24292E;">&gt;</span></span></code></pre></div><h2 id="sse-æœåŠ¡ç«¯ä¸Šä½¿ç”¨" tabindex="-1">SSE æœåŠ¡ç«¯ä¸Šä½¿ç”¨ <a class="header-anchor" href="#sse-æœåŠ¡ç«¯ä¸Šä½¿ç”¨" aria-label="Permalink to &quot;SSE æœåŠ¡ç«¯ä¸Šä½¿ç”¨&quot;">â€‹</a></h2><h3 id="sse-çš„å“åº”å¤´éƒ¨çš„è®¾ç½®" tabindex="-1">SSE çš„å“åº”å¤´éƒ¨çš„è®¾ç½® <a class="header-anchor" href="#sse-çš„å“åº”å¤´éƒ¨çš„è®¾ç½®" aria-label="Permalink to &quot;SSE çš„å“åº”å¤´éƒ¨çš„è®¾ç½®&quot;">â€‹</a></h3><p>â€‹ é¦–å…ˆ SSE åè®®çš„æŠ¥æ–‡å¿…é¡»è¦è®¾ç½®çš„å“åº”å¤´éƒ¨ä¸º<code>content-type</code> <code>cache-control</code> <code>connection</code></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">Content-Type: text/event-stream</span></span>
<span class="line"><span style="color:#e1e4e8;">Cache-Control: no-cache</span></span>
<span class="line"><span style="color:#e1e4e8;">Connection: keep-alive</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">Content-Type: text/event-stream</span></span>
<span class="line"><span style="color:#24292e;">Cache-Control: no-cache</span></span>
<span class="line"><span style="color:#24292e;">Connection: keep-alive</span></span></code></pre></div><blockquote><p>SSE API è§„å®šæ¨é€äº‹ä»¶æµçš„ MIME ç±»å‹ä¸º <code>text/event-stream</code>ã€‚</p><p>å¿…é¡»æŒ‡å®šæµè§ˆå™¨ä¸ç¼“å­˜æœåŠ¡ç«¯å‘é€çš„æ•°æ®ï¼Œä»¥ç¡®ä¿æµè§ˆå™¨å¯ä»¥å®æ—¶æ˜¾ç¤ºæœåŠ¡ç«¯å‘é€çš„æ•°æ®ã€‚</p><p>SSE æ˜¯ä¸€ä¸ªä¸€ç›´ä¿æŒå¼€å¯çš„ TCP è¿æ¥ï¼Œæ‰€ä»¥ Connection ä¸º keep-aliveã€‚</p></blockquote><h3 id="sse-æŠ¥æ–‡æ¶ˆæ¯æ ¼å¼" tabindex="-1">SSE æŠ¥æ–‡æ¶ˆæ¯æ ¼å¼ <a class="header-anchor" href="#sse-æŠ¥æ–‡æ¶ˆæ¯æ ¼å¼" aria-label="Permalink to &quot;SSE æŠ¥æ–‡æ¶ˆæ¯æ ¼å¼&quot;">â€‹</a></h3><p>EventStreamï¼ˆäº‹ä»¶æµï¼‰ä¸º <code>UTF-8</code> æ ¼å¼ç¼–ç çš„<code>æ–‡æœ¬</code>æˆ–ä½¿ç”¨ Base64 ç¼–ç å’Œ gzip å‹ç¼©çš„äºŒè¿›åˆ¶æ¶ˆæ¯ã€‚</p><p>â€‹ æ¯æ¡æ¶ˆæ¯ç”±ä¸€è¡Œæˆ–å¤šè¡Œå­—æ®µï¼ˆ<code>event</code>ã€<code>id</code>ã€<code>retry</code>ã€<code>data</code>ï¼‰ç»„æˆï¼Œæ¯ä¸ªå­—æ®µç»„æˆå½¢å¼ä¸ºï¼š<code>å­—æ®µå:å­—æ®µå€¼</code>ã€‚å­—æ®µä»¥è¡Œä¸ºå•ä½ï¼Œæ¯è¡Œä¸€ä¸ªï¼ˆå³ä»¥ <code>\\n</code> ç»“å°¾ï¼‰ã€‚ä»¥<code>å†’å·</code>å¼€å¤´çš„è¡Œä¸ºæ³¨é‡Šè¡Œï¼Œä¼šè¢«æµè§ˆå™¨å¿½ç•¥ã€‚</p><p>â€‹ æ¯æ¬¡æ¨é€ï¼Œå¯ç”±å¤šä¸ªæ¶ˆæ¯ç»„æˆï¼Œæ¯ä¸ªæ¶ˆæ¯ä¹‹é—´ä»¥ç©ºè¡Œåˆ†éš”ï¼ˆå³æœ€åä¸€ä¸ªå­—æ®µä»¥<code>\\n\\n</code>ç»“å°¾ï¼‰ã€‚</p><blockquote><p>ğŸ“¢ æ³¨æ„ï¼š</p><ul><li>é™¤ä¸Šè¿°å››ä¸ªå­—æ®µå¤–ï¼Œå…¶ä»–æ‰€æœ‰å­—æ®µéƒ½ä¼šè¢«å¿½ç•¥ã€‚</li><li>å¦‚æœä¸€è¡Œå­—æ®µä¸­ä¸åŒ…å«å†’å·ï¼Œåˆ™æ•´è¡Œæ–‡æœ¬å°†è¢«è§†ä¸ºå­—æ®µåï¼Œå­—æ®µå€¼ä¸ºç©ºã€‚</li><li>æ³¨é‡Šè¡Œå¯ä»¥ç”¨æ¥é˜²æ­¢é“¾æ¥è¶…æ—¶ï¼ŒæœåŠ¡ç«¯å¯ä»¥å®šæœŸå‘æµè§ˆå™¨å‘é€ä¸€æ¡æ¶ˆæ¯æ³¨é‡Šè¡Œï¼Œä»¥ä¿æŒè¿æ¥ä¸æ–­ã€‚</li></ul></blockquote><h4 id="_1-event" tabindex="-1">1. event <a class="header-anchor" href="#_1-event" aria-label="Permalink to &quot;1. event&quot;">â€‹</a></h4><p>â€‹ äº‹ä»¶ç±»å‹ã€‚å¦‚æœæŒ‡å®šäº†è¯¥å­—æ®µï¼Œåˆ™åœ¨æµè§ˆå™¨æ”¶åˆ°è¯¥æ¡æ¶ˆæ¯æ—¶ï¼Œä¼šåœ¨å½“å‰ <code>EventSource</code> å¯¹è±¡ï¼ˆè§ 4ï¼‰ä¸Šè§¦å‘ä¸€ä¸ªäº‹ä»¶ï¼Œäº‹ä»¶ç±»å‹å°±æ˜¯è¯¥å­—æ®µçš„å­—æ®µå€¼ã€‚å¯ä»¥ä½¿ç”¨ <code>addEventListener</code> æ–¹æ³•åœ¨å½“å‰ <code>EventSource</code> å¯¹è±¡ä¸Šç›‘å¬ä»»æ„ç±»å‹çš„å‘½åäº‹ä»¶ã€‚</p><p>â€‹ å¦‚æœè¯¥æ¡æ¶ˆæ¯æ²¡æœ‰ <code>event</code> å­—æ®µï¼Œåˆ™ä¼šè§¦å‘ <code>EventSource</code> å¯¹è±¡ <code>onmessage</code> å±æ€§ä¸Šçš„äº‹ä»¶å¤„ç†å‡½æ•°ã€‚å¦‚æœæ¥æ”¶æ¶ˆæ¯ä¸­æœ‰ä¸€ä¸ª event å­—æ®µï¼Œè§¦å‘çš„äº‹ä»¶ä¸ event å­—æ®µçš„å€¼ç›¸åŒã€‚å¦‚æœä¸å­˜åœ¨ event å­—æ®µï¼Œåˆ™å°†è§¦å‘é€šç”¨çš„ <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/EventSource/message_event" target="_blank" rel="noreferrer"><code>message</code></a> äº‹ä»¶</p><h4 id="_2-id" tabindex="-1">2. id <a class="header-anchor" href="#_2-id" aria-label="Permalink to &quot;2. id&quot;">â€‹</a></h4><p>â€‹ äº‹ä»¶ IDã€‚äº‹ä»¶çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œæµè§ˆå™¨ä¼šè·Ÿè¸ªäº‹ä»¶ IDï¼Œå¦‚æœå‘ç”Ÿæ–­è¿ï¼Œæµè§ˆå™¨ä¼šæŠŠæ”¶åˆ°çš„æœ€åä¸€ä¸ªäº‹ä»¶ ID æ”¾åˆ° HTTP Header <code>Last-Event-Id</code> ä¸­è¿›è¡Œé‡è¿ï¼Œä½œä¸ºä¸€ç§ç®€å•çš„åŒæ­¥æœºåˆ¶ã€‚</p><p>â€‹ ä¾‹å¦‚å¯ä»¥åœ¨æœåŠ¡ç«¯å°†æ¯æ¬¡å‘é€çš„äº‹ä»¶ ID å€¼è‡ªåŠ¨åŠ  1ï¼Œå½“æµè§ˆå™¨æ¥æ”¶åˆ°è¯¥äº‹ä»¶ ID åï¼Œä¸‹æ¬¡ä¸æœåŠ¡ç«¯å»ºç«‹è¿æ¥åå†è¯·æ±‚çš„ Header ä¸­å°†åŒæ—¶æäº¤è¯¥äº‹ä»¶ IDï¼ŒæœåŠ¡ç«¯æ£€æŸ¥è¯¥äº‹ä»¶ ID æ˜¯å¦ä¸ºä¸Šæ¬¡å‘é€çš„äº‹ä»¶ IDï¼Œå¦‚æœä¸ä¸Šæ¬¡å‘é€çš„äº‹ä»¶ ID ä¸ä¸€è‡´åˆ™è¯´æ˜æµè§ˆå™¨å­˜åœ¨ä¸æœåŠ¡å™¨è¿æ¥å¤±è´¥çš„æƒ…å†µï¼Œæœ¬æ¬¡éœ€è¦åŒæ—¶å‘é€å‰å‡ æ¬¡æµè§ˆå™¨æœªæ¥æ”¶åˆ°çš„æ•°æ®ã€‚</p><h4 id="_3-retry" tabindex="-1">3. retry <a class="header-anchor" href="#_3-retry" aria-label="Permalink to &quot;3. retry&quot;">â€‹</a></h4><p>â€‹ é‡è¿æ—¶é—´ã€‚æ•´æ•°å€¼ï¼Œå•ä½ msï¼Œå¦‚æœä¸æœåŠ¡å™¨çš„è¿æ¥ä¸¢å¤±ï¼Œæµè§ˆå™¨å°†ç­‰å¾…æŒ‡å®šæ—¶é—´ï¼Œç„¶åå°è¯•é‡æ–°è¿æ¥ã€‚å¦‚æœè¯¥å­—æ®µä¸æ˜¯æ•´æ•°å€¼ï¼Œä¼šè¢«å¿½ç•¥ã€‚</p><p>â€‹ å½“æœåŠ¡ç«¯æ²¡æœ‰æŒ‡å®šæµè§ˆå™¨çš„é‡è¿æ—¶é—´æ—¶ï¼Œç”±æµè§ˆå™¨è‡ªè¡Œå†³å®šæ¯éš”å¤šä¹…ä¸æœåŠ¡ç«¯å»ºç«‹ä¸€æ¬¡è¿æ¥ï¼ˆä¸€èˆ¬ä¸º 30sï¼‰ã€‚</p><h4 id="_4-data" tabindex="-1">4. data <a class="header-anchor" href="#_4-data" aria-label="Permalink to &quot;4. data&quot;">â€‹</a></h4><p>â€‹ æ¶ˆæ¯æ•°æ®ã€‚æ•°æ®å†…å®¹åªèƒ½ä»¥ä¸€ä¸ªå­—ç¬¦ä¸²çš„æ–‡æœ¬å½¢å¼è¿›è¡Œå‘é€ï¼Œå¦‚æœéœ€è¦å‘é€ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œéœ€è¦å°†è¯¥å¯¹è±¡ä»¥ä¸€ä¸ª JSON æ ¼å¼çš„å­—ç¬¦ä¸²çš„å½¢å¼è¿›è¡Œå‘é€ã€‚åœ¨æµè§ˆå™¨æ¥æ”¶åˆ°è¯¥å­—ç¬¦ä¸²åï¼Œå†æŠŠå®ƒè¿˜åŸä¸ºä¸€ä¸ª JSON å¯¹è±¡ã€‚</p><h3 id="sse-æŠ¥æ–‡ç¤ºä¾‹" tabindex="-1">SSE æŠ¥æ–‡ç¤ºä¾‹ <a class="header-anchor" href="#sse-æŠ¥æ–‡ç¤ºä¾‹" aria-label="Permalink to &quot;SSE æŠ¥æ–‡ç¤ºä¾‹&quot;">â€‹</a></h3><p>â€‹ å¦‚ä¸‹äº‹ä»¶æµç¤ºä¾‹ï¼Œå…±å‘é€äº† 4 æ¡æ¶ˆæ¯ï¼Œæ¯æ¡æ¶ˆæ¯é—´ä»¥ä¸€ä¸ªç©ºè¡Œ<code>\\n\\n</code>ä½œä¸ºåˆ†éš”ç¬¦ã€‚æ¯æ¡æ¶ˆæ¯ä¸­çš„å­—æ®µä»¥<code>\\n</code>åˆ†å‰²ã€‚</p><p>â€‹ ç¬¬ä¸€æ¡ä»…ä»…æ˜¯ä¸ªæ³¨é‡Šï¼Œå› ä¸ºå®ƒä»¥å†’å·å¼€å¤´ã€‚</p><p>â€‹ ç¬¬äºŒæ¡æ¶ˆæ¯åªåŒ…å«ä¸€ä¸ª data å­—æ®µï¼Œå€¼ä¸º &#39;this is second message&#39;ã€‚</p><p>â€‹ ç¬¬ä¸‰æ¡æ¶ˆæ¯åŒ…å«ä¸¤ä¸ª data å­—æ®µï¼Œå…¶ä¼šè¢«è§£æä¸ºä¸€ä¸ªå­—æ®µï¼Œå€¼ä¸º &#39;this is third message part 1\\nthis is third message part 2&#39;ã€‚</p><p>â€‹ ç¬¬å››æ¡æ¶ˆæ¯åŒ…å«å®Œæ•´å››ä¸ªå­—æ®µï¼ŒæŒ‡å®šäº†äº‹ä»¶ç±»å‹ä¸º &#39;server-time&#39;ï¼Œäº‹ä»¶ id ä¸º &#39;1&#39;ï¼Œé‡è¿æ—¶é—´ä¸º &#39;30000&#39;msï¼Œæ¶ˆæ¯æ•°æ®ä¸º <code>JSON</code> æ ¼å¼çš„ &#39;{&quot;text&quot;: &quot;this is fourth message&quot;, &quot;time&quot;: &quot;12:00:00&quot;}&#39;ã€‚</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// æ³¨é‡Š</span></span>
<span class="line"><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;"> is first message\\n\\n</span></span>
<span class="line"><span style="color:#6A737D;">// æ¶ˆæ¯1</span></span>
<span class="line"><span style="color:#B392F0;">data</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;"> is second message\\n\\n</span></span>
<span class="line"><span style="color:#6A737D;">// æ¶ˆæ¯2</span></span>
<span class="line"><span style="color:#B392F0;">data</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;"> is third message part one\\n</span></span>
<span class="line"><span style="color:#E1E4E8;">data </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;"> is third message part two\\n\\n</span></span>
<span class="line"><span style="color:#6A737D;">// æ¶ˆæ¯3</span></span>
<span class="line"><span style="color:#B392F0;">event</span><span style="color:#E1E4E8;">: server</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">time\\n</span></span>
<span class="line"><span style="color:#B392F0;">id</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">\\n</span></span>
<span class="line"><span style="color:#B392F0;">retry</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">30000</span><span style="color:#E1E4E8;">\\n</span></span>
<span class="line"><span style="color:#B392F0;">data</span><span style="color:#E1E4E8;">: {</span><span style="color:#9ECBFF;">&quot;text&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;this is fourth message&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;time&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;2023-04-09 12:00:00&quot;</span><span style="color:#E1E4E8;">}\\n\\n</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// æ³¨é‡Š</span></span>
<span class="line"><span style="color:#24292E;">: </span><span style="color:#005CC5;">this</span><span style="color:#24292E;"> is first message\\n\\n</span></span>
<span class="line"><span style="color:#6A737D;">// æ¶ˆæ¯1</span></span>
<span class="line"><span style="color:#6F42C1;">data</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">this</span><span style="color:#24292E;"> is second message\\n\\n</span></span>
<span class="line"><span style="color:#6A737D;">// æ¶ˆæ¯2</span></span>
<span class="line"><span style="color:#6F42C1;">data</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">this</span><span style="color:#24292E;"> is third message part one\\n</span></span>
<span class="line"><span style="color:#24292E;">data </span><span style="color:#005CC5;">this</span><span style="color:#24292E;"> is third message part two\\n\\n</span></span>
<span class="line"><span style="color:#6A737D;">// æ¶ˆæ¯3</span></span>
<span class="line"><span style="color:#6F42C1;">event</span><span style="color:#24292E;">: server</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">time\\n</span></span>
<span class="line"><span style="color:#6F42C1;">id</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">\\n</span></span>
<span class="line"><span style="color:#6F42C1;">retry</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">30000</span><span style="color:#24292E;">\\n</span></span>
<span class="line"><span style="color:#6F42C1;">data</span><span style="color:#24292E;">: {</span><span style="color:#032F62;">&quot;text&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;this is fourth message&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;time&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;2023-04-09 12:00:00&quot;</span><span style="color:#24292E;">}\\n\\n</span></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title">ç¤ºä¾‹ä»£ç å¦‚ä¸‹</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getStream</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">req</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">res</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">  res.</span><span style="color:#B392F0;">setHeader</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Content-type&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;text/event-stream&quot;</span><span style="color:#E1E4E8;">); </span><span style="color:#6A737D;">// å¼€å¯sseåè®®</span></span>
<span class="line"><span style="color:#E1E4E8;">  res.</span><span style="color:#B392F0;">setHeader</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Cache-Control&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;no-cache&quot;</span><span style="color:#E1E4E8;">); </span><span style="color:#6A737D;">// é¿å…æµè§ˆå™¨ç¼“å­˜</span></span>
<span class="line"><span style="color:#E1E4E8;">  res.</span><span style="color:#B392F0;">setHeader</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Connection&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;keep-alive&quot;</span><span style="color:#E1E4E8;">); </span><span style="color:#6A737D;">// sseæ˜¯ä¸€ä¸ªä¸€ç›´ä¿æŒå¼€å¯çš„ TCP è¿æ¥ï¼Œæ‰€ä»¥ Connection ä¸º keep-alive</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">let</span><span style="color:#E1E4E8;"> id </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// å½“è¯·æ±‚æ–­å¼€æ—¶ï¼Œç»“æŸå“åº”</span></span>
<span class="line"><span style="color:#E1E4E8;">  req.</span><span style="color:#B392F0;">on</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;close&quot;</span><span style="color:#E1E4E8;">, () </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    id </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">clearInterval</span><span style="color:#E1E4E8;">(timer);</span></span>
<span class="line"><span style="color:#E1E4E8;">    res.</span><span style="color:#B392F0;">end</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  });</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">timer</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">setInterval</span><span style="color:#E1E4E8;">(() </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// è‡ªå®šä¹‰äº‹ä»¶åç§°customEvent</span></span>
<span class="line"><span style="color:#E1E4E8;">    res.</span><span style="color:#B392F0;">write</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`event: customEvent</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    res.</span><span style="color:#B392F0;">write</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`id: \${</span><span style="color:#E1E4E8;">id</span><span style="color:#9ECBFF;">}</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    res.</span><span style="color:#B392F0;">write</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`retry: 30000</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    res.</span><span style="color:#B392F0;">write</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`data: \${</span><span style="color:#79B8FF;">JSON</span><span style="color:#9ECBFF;">.</span><span style="color:#B392F0;">stringify</span><span style="color:#9ECBFF;">({ content: </span><span style="color:#9ECBFF;">&quot;ä½ å¥½!&quot;</span><span style="color:#9ECBFF;"> })</span><span style="color:#9ECBFF;">}</span><span style="color:#79B8FF;">\\n\\n</span><span style="color:#9ECBFF;">\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    id</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// å“åº”10æ¬¡å†…å®¹å°±ç»“æŸæœ¬æ¬¡HTTPä¼ è¾“</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (id </span><span style="color:#F97583;">&gt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">clearInterval</span><span style="color:#E1E4E8;">(timer);</span></span>
<span class="line"><span style="color:#E1E4E8;">      res.</span><span style="color:#B392F0;">end</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }, </span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getStream</span><span style="color:#24292E;">(</span><span style="color:#E36209;">req</span><span style="color:#24292E;">, </span><span style="color:#E36209;">res</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">  res.</span><span style="color:#6F42C1;">setHeader</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Content-type&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;text/event-stream&quot;</span><span style="color:#24292E;">); </span><span style="color:#6A737D;">// å¼€å¯sseåè®®</span></span>
<span class="line"><span style="color:#24292E;">  res.</span><span style="color:#6F42C1;">setHeader</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Cache-Control&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;no-cache&quot;</span><span style="color:#24292E;">); </span><span style="color:#6A737D;">// é¿å…æµè§ˆå™¨ç¼“å­˜</span></span>
<span class="line"><span style="color:#24292E;">  res.</span><span style="color:#6F42C1;">setHeader</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Connection&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;keep-alive&quot;</span><span style="color:#24292E;">); </span><span style="color:#6A737D;">// sseæ˜¯ä¸€ä¸ªä¸€ç›´ä¿æŒå¼€å¯çš„ TCP è¿æ¥ï¼Œæ‰€ä»¥ Connection ä¸º keep-alive</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">let</span><span style="color:#24292E;"> id </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">// å½“è¯·æ±‚æ–­å¼€æ—¶ï¼Œç»“æŸå“åº”</span></span>
<span class="line"><span style="color:#24292E;">  req.</span><span style="color:#6F42C1;">on</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;close&quot;</span><span style="color:#24292E;">, () </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    id </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">clearInterval</span><span style="color:#24292E;">(timer);</span></span>
<span class="line"><span style="color:#24292E;">    res.</span><span style="color:#6F42C1;">end</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">  });</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">timer</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">setInterval</span><span style="color:#24292E;">(() </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// è‡ªå®šä¹‰äº‹ä»¶åç§°customEvent</span></span>
<span class="line"><span style="color:#24292E;">    res.</span><span style="color:#6F42C1;">write</span><span style="color:#24292E;">(</span><span style="color:#032F62;">\`event: customEvent</span><span style="color:#005CC5;">\\n</span><span style="color:#032F62;">\`</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    res.</span><span style="color:#6F42C1;">write</span><span style="color:#24292E;">(</span><span style="color:#032F62;">\`id: \${</span><span style="color:#24292E;">id</span><span style="color:#032F62;">}</span><span style="color:#005CC5;">\\n</span><span style="color:#032F62;">\`</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    res.</span><span style="color:#6F42C1;">write</span><span style="color:#24292E;">(</span><span style="color:#032F62;">\`retry: 30000</span><span style="color:#005CC5;">\\n</span><span style="color:#032F62;">\`</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    res.</span><span style="color:#6F42C1;">write</span><span style="color:#24292E;">(</span><span style="color:#032F62;">\`data: \${</span><span style="color:#005CC5;">JSON</span><span style="color:#032F62;">.</span><span style="color:#6F42C1;">stringify</span><span style="color:#032F62;">({ content: </span><span style="color:#032F62;">&quot;ä½ å¥½!&quot;</span><span style="color:#032F62;"> })</span><span style="color:#032F62;">}</span><span style="color:#005CC5;">\\n\\n</span><span style="color:#032F62;">\`</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    id</span><span style="color:#D73A49;">++</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// å“åº”10æ¬¡å†…å®¹å°±ç»“æŸæœ¬æ¬¡HTTPä¼ è¾“</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (id </span><span style="color:#D73A49;">&gt;=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">clearInterval</span><span style="color:#24292E;">(timer);</span></span>
<span class="line"><span style="color:#24292E;">      res.</span><span style="color:#6F42C1;">end</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">  }, </span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div></div><h2 id="sse-æ¨é€æˆ¿é—´" tabindex="-1">SSE æ¨é€æˆ¿é—´ <a class="header-anchor" href="#sse-æ¨é€æˆ¿é—´" aria-label="Permalink to &quot;SSE æ¨é€æˆ¿é—´&quot;">â€‹</a></h2><h3 id="åŸºæœ¬æ­¥éª¤" tabindex="-1">åŸºæœ¬æ­¥éª¤ <a class="header-anchor" href="#åŸºæœ¬æ­¥éª¤" aria-label="Permalink to &quot;åŸºæœ¬æ­¥éª¤&quot;">â€‹</a></h3><ol><li>æœåŠ¡ç«¯ç»´æŠ¤æˆ¿é—´ id çš„è¡¨ï¼Œç”¨æ¥å‘é€å¯¹åº”æ¶ˆæ¯ã€‚</li><li>å®¢æˆ·ç«¯å‘é€ HTTP è¯·æ±‚ï¼ŒæœåŠ¡ç«¯åœ¨è¡¨ä¸­æ·»åŠ ä¸€ä¸ªæˆ¿é—´å· idï¼Œå¹¶è¿”å›ç»™å®¢æˆ·ç«¯</li><li>å®¢æˆ·ç«¯åˆ›å»º SSE è¯·æ±‚ï¼Œå¼€å¯é•¿è¿æ¥</li><li>å®¢æˆ·ç«¯çš„<code>EventSource</code>éœ€è¦ç›‘å¬æˆ¿é—´å·äº‹ä»¶ï¼ŒæœåŠ¡ç«¯å¯ä»¥åœ¨éœ€è¦æ¨é€çš„æ—¶å€™å“åº”è¯¥äº‹ä»¶çš„æ¶ˆæ¯ï¼Œè¿™æ ·å®¢æˆ·ç«¯å°±èƒ½æ¥æ”¶åˆ°æ•°æ®äº†ã€‚</li><li>å®¢æˆ·ç«¯å‘é€ HTTP è¯·æ±‚ï¼Œæºå¸¦ä¸Šæˆ¿é—´å· idï¼ŒæœåŠ¡å™¨é€šè¿‡ id åˆ é™¤è¡¨ä¸­çš„æˆ¿é—´å·ã€‚æˆåŠŸåå®¢æˆ·ç«¯æ–­å¼€è¿æ¥ã€‚</li></ol><h2 id="å‚è€ƒ" tabindex="-1">å‚è€ƒ <a class="header-anchor" href="#å‚è€ƒ" aria-label="Permalink to &quot;å‚è€ƒ&quot;">â€‹</a></h2><ol><li><a href="https://juejin.cn/post/7229632570374783034#heading-14" target="_blank" rel="noreferrer">https://juejin.cn/post/7229632570374783034#heading-14</a></li></ol>`,49),e=[o];function t(c,r,E,y,i,d){return n(),a("div",null,e)}const h=s(p,[["render",t]]);export{u as __pageData,h as default};
